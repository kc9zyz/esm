var duration="hour";var options={scaleShowGridLines:true,scaleGridLineColor:"rgba(255,255,255,.05)",scaleFontColor:"rgba(255,255,255,.8)",scaleLabel:"          <%=value%>",scaleGridLineWidth:1,scaleShowHorizontalLines:true,scaleShowVerticalLines:true,bezierCurve:true,bezierCurveTension:.4,pointDot:true,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:5,datasetStroke:true,datasetStrokeWidth:2,datasetFill:true,maintainAspectRatio:true,responsive:true,legendTemplate:'<ul class="<%=name.toLowerCase()%>-legend"><% for (var i=0; i<datasets.length; i++){%><li><span style="background-color:<%=datasets[i].strokeColor%>"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>'};var waypoint=new Waypoint({element:document.getElementById("last-hour-data-chart"),handler:function(){getLastHourData();this.destroy()},offset:"90%"});getLastHourData=function(){$.ajax({url:"data/?asset=recent-data&duration="+duration,success:function(result){var times=[];for(entry in result.times){var time=new Date(result.times[entry]);switch(duration){case"hour":times[entry]=time.toLocaleTimeString();break;case"day":times[entry]=time.toLocaleTimeString();break;case"week":times[entry]=time.toLocaleDateString()+" "+time.toLocaleTimeString();break}}var points=result.panelOutputs;console.log(points);var maxLength=30;if(points.length>maxLength){var newPoints=[];var newTimes=[];for(s in points){if(s%Math.ceil(points.length/maxLength)){newPoints[Math.floor(s/Math.ceil(points.length/maxLength))].push(points[s])}else{newPoints[s/Math.ceil(points.length/maxLength)]=[points[s]];newTimes[s/Math.ceil(points.length/maxLength)]=times[s]}}console.log(newPoints);for(s in newPoints){var total=0;for(i in newPoints[s]){total+=parseInt(newPoints[s][i])}newPoints[s]=total/newPoints[s].length}points=newPoints;times=newTimes}updateLastHour([times,points])}})};updateLastHour=function(points){var lastHourData={labels:points[0],datasets:[{label:"Watts",fillColor:"rgba(151,187,205,0.2)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(151,187,205,1)",data:points[1]}]};Chart.types.Line.extend({name:"LineAlt",draw:function(){Chart.types.Line.prototype.draw.apply(this,arguments);var ctx=this.chart.ctx;ctx.save();ctx.textAlign="center";ctx.textBaseline="bottom";ctx.fillStyle=this.options.scaleFontColor;var x=this.scale.xScalePaddingLeft*.4;var y=this.chart.height/2;ctx.translate(x,y);ctx.rotate(-90*Math.PI/180);ctx.fillText("Watts",0,0);ctx.restore()}});var ctx=document.getElementById("last-hour-data-chart");var container=document.getElementById("recentCol");ctx.width=container.clientWidth;if(this.lastHourChart){this.lastHourChart.destroy()}this.lastHourChart=new Chart(ctx.getContext("2d")).LineAlt(lastHourData,options);this.firstTime=0};$("#currentHour").on("click",function(event){$("#currentDrop").html("Select Range - "+$(this).text()+' <span class="caret"></span>');duration="hour";getLastHourData()});$("#currentDay").on("click",function(event){$("#currentDrop").html("Select Range - "+$(this).text()+' <span class="caret"></span>');duration="day";getLastHourData()});$("#currentWeek").on("click",function(event){$("#currentDrop").html("Select Range - "+$(this).text()+' <span class="caret"></span>');duration="week";getLastHourData()});
